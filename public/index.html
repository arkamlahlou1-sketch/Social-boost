<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Social Boost</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background: #f0f2f5; }
  h1 { text-align: center; color: #4f46e5; }
  #tasksList { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 20px; }
  .task-card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center; }
  button { padding: 10px 20px; border: none; border-radius: 10px; background: #4f46e5; color: white; cursor: pointer; margin-top: 10px; }
  button:disabled { background: gray; cursor: not-allowed; }
  #userBalance { font-weight: bold; color: green; }
</style>
</head>
<body>

<h1>Social Boost</h1>
<p>رصيدك الحالي: <span id="userBalance">0</span> نقطة</p>

<div id="tasksList"></div>

<button id="confirmTask" onclick="confirmTask()" disabled>انتظر...</button>

<script>
const CONFIG = {
  API_BASE: "https://social-boost-production-eac9.up.railway.app",
  USER_ID: localStorage.getItem("userId")
};

let activeTaskId = null;

// تسجيل دخول تلقائي
async function autoLogin() {
  if (!CONFIG.USER_ID) {
    const res = await fetch(`${CONFIG.API_BASE}/auth/login`, { method: "POST" });
    const data = await res.json();
    localStorage.setItem("userId", data.userId);
    CONFIG.USER_ID = data.userId;
  }
  updateBalance();
}

// تحديث الرصيد
async function updateBalance() {
  const res = await fetch(`${CONFIG.API_BASE}/tasks`); // نقوم بسحب نقاط من السيرفر
  // هنا السيرفر يرسل نقاط لكل مهمة مكتملة
  // سنحسبها يدويًا من localStorage أو سنطلب endpoint لاحق
  // حاليا نترك الرصيد ثابت كمثال
  document.getElementById('userBalance').innerText = "0";
}

// تحميل المهام
async function loadTasks() {
  const list = document.getElementById('tasksList');
  const res = await fetch(`${CONFIG.API_BASE}/tasks`);
  const tasks = await res.json();

  if (!tasks || tasks.length === 0) {
    list.innerHTML = `<p style="text-align:center;color:gray;">لا توجد مهام متاحة</p>`;
    return;
  }

  list.innerHTML = tasks.map(task => `
    <div class="task-card">
      <h3>زيارة حساب</h3>
      <p>المكافأة: ${task.reward} نقطة</p>
      <button onclick="startTask('${task.id}', '${task.link}')">بدء المهمة</button>
    </div>
  `).join('');
}

// بدء المهمة
async function startTask(taskId, link) {
  activeTaskId = taskId;

  // إرسال إلى السيرفر بدء المهمة
  await fetch(`${CONFIG.API_BASE}/tasks/start`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ userId: CONFIG.USER_ID, taskId })
  });

  window.open(link, "_blank"); // فتح الرابط

  // عداد 20 ثانية
  let seconds = 20;
  const btn = document.getElementById("confirmTask");
  btn.disabled = true;

  const timer = setInterval(() => {
    btn.innerText = `انتظر ${seconds--} ثانية`;
    if (seconds < 0) {
      clearInterval(timer);
      btn.disabled = false;
      btn.innerText = "تأكيد المهمة";
    }
  }, 1000);
}

// تأكيد المهمة بعد انتهاء الوقت
async function confirmTask() {
  if (!activeTaskId) return;

  const res = await fetch(`${CONFIG.API_BASE}/tasks/complete`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ userId: CONFIG.USER_ID, taskId: activeTaskId })
  });

  const data = await res.json();
  if (data.success) {
    alert(`تمت المهمة! رصيدك الآن: ${data.points} نقطة`);
    location.reload();
  } else {
    alert(data.error || "حدث خطأ أثناء تأكيد المهمة");
  }
}

// عند تحميل الصفحة
window.onload = async () => {
  await autoLogin();
  await loadTasks();
};
</script>

</body>
</html>
